name: 'Deploy to ECS'
description: 'Deploys a Docker image to AWS ECS by updating task definition and service'
branding:
  icon: 'upload-cloud'
  color: 'orange'

inputs:
  ecr-image:
    description: 'Full ECR image URI with tag (e.g., 123456789012.dkr.ecr.eu-central-1.amazonaws.com/repo:tag)'
    required: true
  task-family:
    description: 'ECS task definition family name'
    required: true
  cluster-name:
    description: 'ECS cluster name'
    required: true
  service-name:
    description: 'ECS service name'
    required: true
  task-def-ssm-param:
    description: 'SSM parameter name containing the task definition template ARN'
    required: true
  container-index:
    description: 'Index of the container in the task definition to update (default: 0)'
    required: false
    default: '0'

runs:
  using: 'composite'
  steps:
    - name: Deploy to ECS
      shell: bash
      run: |
        # Get task definition template from Parameter Store
        TASK_DEF_ARN=$(aws ssm get-parameter --name "${{ inputs.task-def-ssm-param }}" --query "Parameter.Value" --output text)

        # Get the task definition JSON
        TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition "$TASK_DEF_ARN" --query 'taskDefinition | {
          family: family,
          taskRoleArn: taskRoleArn,
          executionRoleArn: executionRoleArn,
          networkMode: networkMode,
          containerDefinitions: containerDefinitions,
          volumes: volumes,
          placementConstraints: placementConstraints,
          requiresCompatibilities: requiresCompatibilities,
          cpu: cpu,
          memory: memory
        }' --output json)

        # Create a temporary file for the task definition
        echo "$TASK_DEF_JSON" > task-def.json

        # Update the image in the task definition
        jq --arg IMAGE "${{ inputs.ecr-image }}" --argjson INDEX "${{ inputs.container-index }}" \
          '.containerDefinitions[$INDEX].image = $IMAGE' task-def.json > task-def-new.json

        # Register new task definition
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --family "${{ inputs.task-family }}" \
          --cli-input-json "$(cat task-def-new.json)" \
          --query "taskDefinition.taskDefinitionArn" \
          --output text)

        echo "Registered new task definition: $NEW_TASK_DEF_ARN"

        # Clean up temporary files
        rm task-def.json task-def-new.json

        # Update the service with new task definition
        aws ecs update-service \
          --cluster "${{ inputs.cluster-name }}" \
          --service "${{ inputs.service-name }}" \
          --task-definition "$NEW_TASK_DEF_ARN" \
          --force-new-deployment

        echo "âœ… ECS service updated successfully"
        echo "- Cluster: ${{ inputs.cluster-name }}"
        echo "- Service: ${{ inputs.service-name }}"
        echo "- Image: ${{ inputs.ecr-image }}"
